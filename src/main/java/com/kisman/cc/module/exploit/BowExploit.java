package com.kisman.cc.module.exploit;

import com.kisman.cc.Kisman;
import com.kisman.cc.event.events.PacketEvent;
import com.kisman.cc.module.Category;
import com.kisman.cc.module.Module;
import com.kisman.cc.settings.Setting;
import i.gishreloaded.gishcode.utils.visual.ChatUtils;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.item.*;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketPlayerTryUseItem;
import net.minecraft.util.EnumHand;

public class BowExploit extends Module {
//    public static BowExploit instance;

    private Setting bows = new Setting("Bows", this, true);

    private Setting eggs = new Setting("Eggs", this, true);
    private Setting pearls = new Setting("Pearls", this, true);
    private Setting snowballs = new Setting("SnowBalls", this, true);
    private Setting timeOut = new Setting("TimeOut", this, 5000, 100, 20000, true);
    private Setting spoofs = new Setting("Spoofs", this, 10, 1, 300, true);
    private Setting bypass = new Setting("Bypass", this, false);
    private Setting debug = new Setting("Debug", this, false);

//    private Setting power = new Setting("Power", this, 1, 4, 10, true);

    private boolean shooting = false;
    private long lastShootTime;

//    public int one = 1;
//    public int two = 1;

    public BowExploit() {
        super("BowExploit", "BowExploit", Category.EXPLOIT);

//        instance = this;

//        setmgr.rSetting(power);

        setmgr.rSetting(bows);
        setmgr.rSetting(eggs);
        setmgr.rSetting(pearls);
        setmgr.rSetting(snowballs);
        setmgr.rSetting(timeOut);
        setmgr.rSetting(spoofs);
        setmgr.rSetting(bypass);
        setmgr.rSetting(debug);

//        Kisman.instance.settingsManager.rSetting(new Setting("1", this, 250, 1, 1000, true));
//        Kisman.instance.settingsManager.rSetting(new Setting("2", this, 250, 1, 1000, true));
    }

/*    public void update() {
        this.one = (int) Kisman.instance.settingsManager.getSettingByName(this, "1").getValDouble();
        this.two = (int) Kisman.instance.settingsManager.getSettingByName(this, "2").getValDouble();
    }*/

    public void onEnable() {
        Kisman.EVENT_BUS.subscribe(listener);
    }

    public void onDisable() {
        Kisman.EVENT_BUS.unsubscribe(listener);
    }

    @EventHandler
    private final Listener<PacketEvent.Send> listener = new Listener<>(event -> {
        if (event.getPacket() instanceof CPacketPlayerDigging) {
            CPacketPlayerDigging packet = (CPacketPlayerDigging) event.getPacket();

            if (packet.getAction() == CPacketPlayerDigging.Action.RELEASE_USE_ITEM) {
                ItemStack handStack = mc.player.getHeldItem(EnumHand.MAIN_HAND);

                if (!handStack.isEmpty() && handStack.getItem() != null && handStack.getItem() instanceof ItemBow && bows.getValBoolean()) {
                    doSpoofs();
                    if (debug.getValBoolean()) ChatUtils.error("trying to spoof");
                }
            }

        } else if (event.getPacket() instanceof CPacketPlayerTryUseItem) {
            CPacketPlayerTryUseItem packet2 = (CPacketPlayerTryUseItem) event.getPacket();

            if (packet2.getHand() == EnumHand.MAIN_HAND) {
                ItemStack handStack = mc.player.getHeldItem(EnumHand.MAIN_HAND);

                if (!handStack.isEmpty() && handStack.getItem() != null) {
                    if (handStack.getItem() instanceof ItemEgg && eggs.getValBoolean()) {
                        doSpoofs();
                    } else if (handStack.getItem() instanceof ItemEnderPearl && pearls.getValBoolean()) {
                        doSpoofs();
                    } else if (handStack.getItem() instanceof ItemSnowball && snowballs.getValBoolean()) {
                        doSpoofs();
                    }
                }
            }
        }
/*        if(mc.player != null && mc.world != null) {
            float yaw = mc.player.rotationYaw;

            if(event.getPacket() instanceof CPacketPlayerTryUseItem && mc.player.getHeldItemMainhand().getItem() instanceof ItemBow) {
                mc.player.connection.sendPacket(new CPacketPlayer.PositionRotation(
                        mc.player.posX - Math.sin(yaw) * (int) 4,
                        mc.player.posY + 5,
                        mc.player.posZ + Math.cos(yaw) * 4,
                        mc.player.rotationYaw,
                        mc.player.rotationPitch,
                        false
                ));
            }
        }*/
    });

    private void doSpoofs() {
        if (System.currentTimeMillis() - lastShootTime >= timeOut.getValDouble()) {
            shooting = true;
            lastShootTime = System.currentTimeMillis();

            mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.START_SPRINTING));

            for (int index = 0; index < spoofs.getValDouble(); ++index) {
                if (bypass.getValBoolean()) {
                    mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 1e-10, mc.player.posZ, false));
                    mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY - 1e-10, mc.player.posZ, true));
                } else {
                    mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY - 1e-10, mc.player.posZ, true));
                    mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 1e-10, mc.player.posZ, false));
                }

            }

            if (debug.getValBoolean()) ChatUtils.complete("Spoofed");

            shooting = false;
        }
    }
}
